name: Deploy Worker System
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Create Fresh Compose File
        run: |
          # This creates a brand new file right in the runner folder
          cat <<EOF > docker-compose.yml
          services:
            redis:
              image: redis:alpine
              container_name: redis
              ports:
                - "6379:6379"

            worker:
              image: python:3.9-slim
              container_name: worker
              depends_on:
                - redis
              command: python -c "print('Worker started')"

            dashboard:
              image: nginx:alpine
              container_name: dashboard
              ports:
                - "5555:80"
          EOF

      - name: Deploy the Created File
        run: |
          # Use sudo to force it through any permission walls
          sudo docker compose -f docker-compose.yml down --remove-orphans
          sudo docker compose -f docker-compose.yml up -d
          sudo docker ps
